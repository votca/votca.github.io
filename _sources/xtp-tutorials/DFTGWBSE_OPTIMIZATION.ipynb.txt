{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## DFT + GWBSE Optimization Using CO"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Introduction\n",
    "This tutorial explains how to perform a molecular geometric optimization using the **GWBSE** method. See [the GW Compendium: A Practical Guide to Theoretical Photoemission Spectroscopy](https://doi.org/10.3389/fchem.2019.00377), for an excellent introduction to the method."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Requirements\n",
    "* You will need to install **VOTCA** using the instructions described [here](https://github.com/votca/votca/blob/master/share/doc/INSTALL.rst)\n",
    "* Once the installation is completed you need to activate the VOTCA enviroment by running the `VOTCARC.bash` script that has been installed at the bin subfolder for the path that you have provided for the installation step above"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Preparing the input\n",
    "To run a DFT-GWBSE calculation we will use the [xtp_tools](https://www.votca.org/xtp/xtp_tools_overview.html) calculator. First, Let create a folder to store the input `options` for XTP and copy the defaults in there"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2021-06-18T13:40:52.026040Z",
     "iopub.status.busy": "2021-06-18T13:40:52.025534Z",
     "iopub.status.idle": "2021-06-18T13:40:53.254891Z",
     "shell.execute_reply": "2021-06-18T13:40:53.254313Z"
    }
   },
   "outputs": [],
   "source": [
    "!mkdir -p OPTIONFILES\n",
    "!cp $VOTCASHARE/xtp/xml/dftgwbse.xml OPTIONFILES"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "we can now change the calculator mode from single point energy calculation to optimization as follows,"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2021-06-18T13:40:53.259001Z",
     "iopub.status.busy": "2021-06-18T13:40:53.258563Z",
     "iopub.status.idle": "2021-06-18T13:40:53.269030Z",
     "shell.execute_reply": "2021-06-18T13:40:53.269360Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "The option 'optimize' on file 'OPTIONFILES/dftgwbse.xml' has been set to 'true'\n",
      "The option 'maxiter' on file 'OPTIONFILES/dftgwbse.xml' has been set to '1'\n",
      "The option 'energy' on file 'OPTIONFILES/dftgwbse.xml' has been set to '1.e-1'\n"
     ]
    }
   ],
   "source": [
    "from xml_editor import edit_calculator\n",
    "edit_calculator(\"dftgwbse\", \"optimize\", \"true\")\n",
    "edit_calculator(\"dftgwbse\", \"maxiter\", \"1\")\n",
    "edit_calculator(\"dftgwbse\", \"energy\", \"1.e-1\")\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "You can find all *dftgwbse* default options [here](https://www.votca.org/xtp/dftgwbse.html). You can for instance change the `basisset` and `auxbasisset` to `def2-svp` and `aux-def2-svp`, respectively."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2021-06-18T13:40:53.272828Z",
     "iopub.status.busy": "2021-06-18T13:40:53.272022Z",
     "iopub.status.idle": "2021-06-18T13:40:53.276290Z",
     "shell.execute_reply": "2021-06-18T13:40:53.276621Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "The option 'basisset' on file 'OPTIONFILES/dftgwbse.xml' has been set to '3-21G'\n",
      "The option 'auxbasisset' on file 'OPTIONFILES/dftgwbse.xml' has been set to 'aux-def2-svp'\n"
     ]
    }
   ],
   "source": [
    "edit_calculator(\"dftgwbse\", \"basisset\", \"3-21G\")\n",
    "edit_calculator(\"dftgwbse\", \"auxbasisset\", \"aux-def2-svp\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Finally, to run the calculation we just need the following command,"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {
    "execution": {
     "iopub.execute_input": "2021-06-18T13:40:53.282065Z",
     "iopub.status.busy": "2021-06-18T13:40:53.279670Z",
     "iopub.status.idle": "2021-06-18T13:41:01.955032Z",
     "shell.execute_reply": "2021-06-18T13:41:01.955493Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "==================================================\r\n",
      "========   VOTCA (http://www.votca.org)   ========\r\n",
      "==================================================\r\n",
      "\r\n",
      "please submit bugs to https://github.com/votca/xtp/issues\r\n",
      "\r\n",
      "xtp_tools, version 2022-dev gitid: b2c0c16 (compiled Jun 18 2021, 13:32:58)\r\n",
      "votca_csg, version 2022-dev gitid: b2c0c16 (compiled Jun 18 2021, 13:18:54)\r\n",
      "votca_tools, version 2022-dev gitid: b2c0c16 (compiled Jun 18 2021, 13:16:30)\r\n",
      "\r\n",
      "Initializing tool\r\n",
      "... dftgwbse Evaluating tool\r\n",
      "... dftgwbse  Using 2 threads\r\n",
      "... ... Reading structure from CO.xyz\r\n",
      "... ... Requested geometry optimization of excited state s1\r\n",
      "... ... Initial state: s1\r\n",
      "... ... Using oscillator strength tracker with threshold 0.0001\r\n",
      "... ... Convergence of total energy: 0.100000 Hartree \r\n",
      "... ... Convergence of RMS Force:    0.000030 Hartree/Bohr \r\n",
      "... ... Convergence of Max Force:    0.000100 Hartree/Bohr \r\n",
      "... ... Convergence of RMS Step:     0.000600 Bohr \r\n",
      "... ... Convergence of Max Step:     0.001000 Bohr \r\n",
      "... ... Initial trust radius:        0.018897 Bohr\r\n",
      "... ... Next State is: s1\r\n",
      "... ... 2021-6-18 13:40:56 Using 2 threads\r\n",
      "... ... 2021-6-18 13:40:56 Using native Eigen implementation, no BLAS overload \r\n",
      "... ...  Molecule Coordinates [A] \r\n",
      "... ...   C   +0.0010 +0.0000 +0.0000\r\n",
      "... ...   O   +1.2000 +0.0000 +0.0000\r\n",
      "... ... 2021-6-18 13:40:56 Loaded DFT Basis Set 3-21G with 18 functions\r\n",
      "... ... 2021-6-18 13:40:56 Loaded AUX Basis Set aux-def2-svp with 96 functions\r\n",
      "... ... 2021-6-18 13:40:56 Total number of electrons: 14\r\n",
      "... ... 2021-6-18 13:40:56 Smallest value of AOOverlap matrix is 0.051195\r\n",
      "... ... 2021-6-18 13:40:56 Removed 0 basisfunction from inverse overlap matrix\r\n",
      "... ... 2021-6-18 13:40:56 Convergence Options:\r\n",
      "... ... \t\t Delta E [Ha]: 1e-07\r\n",
      "... ... \t\t DIIS max error: 1e-07\r\n",
      "... ... \t\t DIIS histlength: 20\r\n",
      "... ... \t\t ADIIS start: 0.8\r\n",
      "... ... \t\t DIIS start: 0.002\r\n",
      "... ... \t\t Deleting oldest element from DIIS hist\r\n",
      "... ... \t\t Levelshift[Ha]: 0\r\n",
      "... ... \t\t Levelshift end: 0.2\r\n",
      "... ... \t\t Mixing Parameter alpha: 0.7\r\n",
      "... ... 2021-6-18 13:40:56 Setup invariant parts of Electron Repulsion integrals \r\n",
      "... ... 2021-6-18 13:40:56 Constructed independent particle hamiltonian \r\n",
      "... ... 2021-6-18 13:40:56 Nuclear Repulsion Energy is 21.1847439\r\n",
      "... ... 2021-6-18 13:40:56 Using hybrid functional with alpha=0.25\r\n",
      "... ... 2021-6-18 13:40:56 Setup numerical integration grid medium for vxc functional XC_HYB_GGA_XC_PBEH\r\n",
      "... ... 2021-6-18 13:40:56 Setup Initial Guess using: atom\r\n",
      "... ... 2021-6-18 13:40:56 Calculating atom density for C\r\n",
      "... ... 2021-6-18 13:40:57 Calculating atom density for O\r\n",
      "... ... 2021-6-18 13:40:58 STARTING SCF cycle\r\n",
      "... ...  --------------------------------------------------------------------------\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 1 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.364694295\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.358958749787\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot 0\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 2 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.39958037\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.138444555234\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot -0.0348860748635\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 3 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.443974704\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.100121195784\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot -0.0443943339757\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 4 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.52508776\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.117934266239\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot -0.0811130554099\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 5 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.509068708\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.164729478519\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot 0.0160190513303\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 6 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.544617812\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.018998711076\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot -0.0355491031885\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 7 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.541886093\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.0491820053907\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot 0.00273171836734\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 8 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.544883258\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.0140039721849\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot -0.00299716528224\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 9 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.545133533\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.00377962067139\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot -0.000250274150744\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 10 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.545113983\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.00538537225869\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot 1.95501045823e-05\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 11 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.545151787\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 0.000780748059078\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot -3.78048894447e-05\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 12 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.5451526\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 3.66786406371e-06\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot -8.12325311017e-07\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 13 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.5451526\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 1.13750086066e-07\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot -2.04352090805e-11\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:58 Iteration 14 of 100\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy -112.5451526\r\n",
      "... ... 2021-6-18 13:40:58 DIIs error 6.44912474928e-09\r\n",
      "... ... 2021-6-18 13:40:58 Delta Etot 0\r\n",
      "... ... 2021-6-18 13:40:58 Total Energy has converged to 0[Ha] after 14 iterations. DIIS error is converged up to 6.44912475e-09\r\n",
      "... ... 2021-6-18 13:40:58 Final Single Point Energy -112.5451526 Ha\r\n",
      "... ... 2021-6-18 13:40:58 Final Local Exc contribution -10.3509474699 Ha\r\n",
      "... ... 2021-6-18 13:40:58 Final Non Local Ex contribution -3.29400255021 Ha\r\n",
      "... ...   Orbital energies: \r\n",
      "... ...   index occupation energy(Hartree) \r\n",
      "... ...      0      2   -19.2419944822\r\n",
      "... ...      1      2   -10.3166455939\r\n",
      "... ...      2      2   -1.1842207506\r\n",
      "... ...      3      2   -0.5763673198\r\n",
      "... ...      4      2   -0.4662566189\r\n",
      "... ...      5      2   -0.4662566189\r\n",
      "... ...      6      2   -0.3807869182\r\n",
      "... ...      7      0   -0.0340775619\r\n",
      "... ...      8      0   -0.0340775619\r\n",
      "... ...      9      0   +0.3139136679\r\n",
      "... ...     10      0   +0.7020229601\r\n",
      "... ...     11      0   +0.7020229601\r\n",
      "... ...     12      0   +0.7878578218\r\n",
      "... ...     13      0   +1.0531051427\r\n",
      "... ...     14      0   +1.4534308429\r\n",
      "... ...     15      0   +1.4534308429\r\n",
      "... ...     16      0   +1.5015681038\r\n",
      "... ...     17      0   +2.9080220709\r\n",
      "... ... 2021-6-18 13:40:58 Electric Dipole is[e*bohr]:\r\n",
      "\t\t dx=-0.0486864645033\r\n",
      "\t\t dy=-1.2953897219e-10\r\n",
      "\t\t dz=-1.29525332402e-10\r\n",
      "... ... Writing result to CO.orb\r\n",
      "... ... Parsing DFT data from CO.orb and CO.orb\r\n",
      "... ... QM energy[Hrt]: -112.54515260 \r\n",
      "... ... 2021-6-18 13:40:58 RPA level range [0:17]\r\n",
      "... ... 2021-6-18 13:40:58 GW  level range [0:17]\r\n",
      "... ... 2021-6-18 13:40:58 BSE level range occ[0:6]  virt[7:17]\r\n",
      "... ...  BSE type: full\r\n",
      "... ... 2021-6-18 13:40:58 BSE Hamiltonian has size 154x154\r\n",
      "... ...  BSE without Hqp offdiagonal elements\r\n",
      "... ...  Running GW as: evGW\r\n",
      "... ...  g_sc_limit [Hartree]: 1e-05\r\n",
      "... ...  gw_sc_limit [Hartree]: 1e-05\r\n",
      "... ...  Tasks: \r\n",
      "... ...  GW \r\n",
      "... ...  singlets \r\n",
      "... ...  Store: \r\n",
      "... ...  GW \r\n",
      "... ...  Sigma integration: ppm\r\n",
      "... ...  eta: 0.001\r\n",
      "... ...  Quadrature integration order : 12\r\n",
      "... ...  Quadrature integration scheme : legendre\r\n",
      "... ...  Alpha smoothing parameter : 0.001\r\n",
      "... ...  QP solver: grid\r\n",
      "... ...  QP grid steps: 1001\r\n",
      "... ...  QP grid spacing: 0.001\r\n",
      "... ...  evGW with Anderson update with history 20 using alpha 0.7\r\n",
      "... ... 2021-6-18 13:40:58 Using 2 threads\r\n",
      "... ... 2021-6-18 13:40:58 Using native Eigen implementation, no BLAS overload \r\n",
      "... ... 2021-6-18 13:40:58 Molecule Coordinates [A] \r\n",
      "... ...     0    C   0.0010 0.0000 0.0000\r\n",
      "... ...     1    O   1.2000 0.0000 0.0000\r\n",
      "... ... 2021-6-18 13:40:58 DFT data was created by xtp\r\n",
      "... ... 2021-6-18 13:40:58 Loaded DFT Basis Set 3-21G\r\n",
      "... ... 2021-6-18 13:40:58 Filled DFT Basis of size 18\r\n",
      "... ... 2021-6-18 13:40:58 Loaded Auxbasis Set aux-def2-svp\r\n",
      "... ... 2021-6-18 13:40:58 Filled Auxbasis of size 96\r\n",
      "... ... 2021-6-18 13:40:58 Calculating Mmn_beta (3-center-repulsion x orbitals)  \r\n",
      "... ... 2021-6-18 13:40:58 Calculated Mmn_beta (3-center-repulsion x orbitals)  \r\n",
      "... ... 2021-6-18 13:40:58 Integrating Vxc with functional XC_HYB_GGA_XC_PBEH\r\n",
      "... ... 2021-6-18 13:40:58 Set hybrid exchange factor: 0.25\r\n",
      "... ... 2021-6-18 13:40:58 Calculated exchange-correlation expectation values \r\n",
      "... ... 2021-6-18 13:40:58 Calculated Hartree exchange contribution\r\n",
      "... ... 2021-6-18 13:40:58 Scissor shifting DFT energies by: 0 Hrt\r\n",
      "... ...   ====== Perturbative quasiparticle energies (Hartree) ====== \r\n",
      "... ...    DeltaHLGap = +0.290091 Hartree\r\n",
      "... ...   Level =    0 DFT = -19.2420 VXC = -2.3112 S-X = -3.6465 S-C = +0.5605 GWA = -20.0168\r\n",
      "... ...   Level =    1 DFT = -10.3166 VXC = -1.7029 S-X = -2.6729 S-C = +0.2825 GWA = -11.0042\r\n",
      "... ...   Level =    2 DFT = -1.1842 VXC = -0.6137 S-X = -0.9172 S-C = +0.1554 GWA = -1.3324\r\n",
      "... ...   Level =    3 DFT = -0.5764 VXC = -0.5631 S-X = -0.7702 S-C = +0.0854 GWA = -0.6981\r\n",
      "... ...   Level =    4 DFT = -0.4663 VXC = -0.5082 S-X = -0.6427 S-C = +0.0198 GWA = -0.5809\r\n",
      "... ...   Level =    5 DFT = -0.4663 VXC = -0.5082 S-X = -0.6427 S-C = +0.0198 GWA = -0.5809\r\n",
      "... ...   HOMO  =    6 DFT = -0.3808 VXC = -0.4453 S-X = -0.5898 S-C = +0.0344 GWA = -0.4910\r\n",
      "... ...   LUMO  =    7 DFT = -0.0341 VXC = -0.4302 S-X = -0.2453 S-C = -0.0049 GWA = +0.1458\r\n",
      "... ...   Level =    8 DFT = -0.0341 VXC = -0.4302 S-X = -0.2453 S-C = -0.0049 GWA = +0.1458\r\n",
      "... ...   Level =    9 DFT = +0.3139 VXC = -0.3251 S-X = -0.1498 S-C = -0.0129 GWA = +0.4763\r\n",
      "... ...   Level =   10 DFT = +0.7020 VXC = -0.3344 S-X = -0.0932 S-C = -0.0696 GWA = +0.8736\r\n",
      "... ...   Level =   11 DFT = +0.7020 VXC = -0.3344 S-X = -0.0932 S-C = -0.0696 GWA = +0.8736\r\n",
      "... ...   Level =   12 DFT = +0.7879 VXC = -0.4744 S-X = -0.2017 S-C = -0.0616 GWA = +0.9989\r\n",
      "... ...   Level =   13 DFT = +1.0531 VXC = -0.4122 S-X = -0.1763 S-C = -0.0810 GWA = +1.2080\r\n",
      "... ...   Level =   14 DFT = +1.4534 VXC = -0.5240 S-X = -0.1916 S-C = -0.2308 GWA = +1.5550\r\n",
      "... ...   Level =   15 DFT = +1.4534 VXC = -0.5240 S-X = -0.1916 S-C = -0.2308 GWA = +1.5550\r\n",
      "... ...   Level =   16 DFT = +1.5016 VXC = -0.5043 S-X = -0.1976 S-C = -0.1214 GWA = +1.6868\r\n",
      "... ...   Level =   17 DFT = +2.9080 VXC = -0.5572 S-X = -0.2105 S-C = +0.0448 GWA = +3.2995\r\n",
      "... ... 2021-6-18 13:40:59 Calculated offdiagonal part of Sigma  \r\n",
      "... ... 2021-6-18 13:40:59 Full quasiparticle Hamiltonian  \r\n",
      "... ...   ====== Diagonalized quasiparticle energies (Hartree) ====== \r\n",
      "... ...   Level =    0 PQP = -20.016823 DQP = -20.017086 \r\n",
      "... ...   Level =    1 PQP = -11.004165 DQP = -11.004430 \r\n",
      "... ...   Level =    2 PQP = -1.332367 DQP = -1.333169 \r\n",
      "... ...   Level =    3 PQP = -0.698087 DQP = -0.698575 \r\n",
      "... ...   Level =    4 PQP = -0.580907 DQP = -0.585676 \r\n",
      "... ...   Level =    5 PQP = -0.580907 DQP = -0.585676 \r\n",
      "... ...   HOMO  =    6 PQP = -0.490952 DQP = -0.491293 \r\n",
      "... ...   LUMO  =    7 PQP = +0.145848 DQP = +0.144043 \r\n",
      "... ...   Level =    8 PQP = +0.145848 DQP = +0.144043 \r\n",
      "... ...   Level =    9 PQP = +0.476330 DQP = +0.473843 \r\n",
      "... ...   Level =   10 PQP = +0.873583 DQP = +0.873570 \r\n",
      "... ...   Level =   11 PQP = +0.873583 DQP = +0.873570 \r\n",
      "... ...   Level =   12 PQP = +0.998891 DQP = +0.996300 \r\n",
      "... ...   Level =   13 PQP = +1.207971 DQP = +1.209717 \r\n",
      "... ...   Level =   14 PQP = +1.554953 DQP = +1.561541 \r\n",
      "... ...   Level =   15 PQP = +1.554953 DQP = +1.561541 \r\n",
      "... ...   Level =   16 PQP = +1.686783 DQP = +1.679347 \r\n",
      "... ...   Level =   17 PQP = +3.299532 DQP = +3.312457 \r\n",
      "... ... 2021-6-18 13:40:59 Diagonalized QP Hamiltonian  \r\n",
      "... ... 2021-6-18 13:40:59 Setup Full singlet hamiltonian \r\n",
      "... ... 2021-6-18 13:40:59 Davidson Solver using 2 threads.\r\n",
      "... ... 2021-6-18 13:40:59 Tolerance : 0.0001\r\n",
      "... ... 2021-6-18 13:40:59 DPR Correction\r\n",
      "... ... 2021-6-18 13:40:59 Matrix size : 154x154\r\n",
      "... ... 2021-6-18 13:40:59 iter\tSearch Space\tNorm\r\n",
      "... ... 2021-6-18 13:40:59    0           10 \t 1.29e-01 \t  0.00% converged\r\n",
      "... ... 2021-6-18 13:40:59    1           17 \t 1.62e-02 \t  0.00% converged\r\n",
      "... ... 2021-6-18 13:40:59    2           24 \t 1.35e-03 \t 40.00% converged\r\n",
      "... ... 2021-6-18 13:40:59    3           29 \t 1.03e-04 \t 80.00% converged\r\n",
      "... ... 2021-6-18 13:40:59    4           31 \t 8.49e-05 \t 100.00% converged\r\n",
      "... ... 2021-6-18 13:40:59 Davidson converged after 4 iterations.\r\n",
      "... ... 2021-6-18 13:40:59-----------------------------------\r\n",
      "... ... 2021-6-18 13:40:59- Davidson ran for 0.010589845secs.\r\n",
      "... ... 2021-6-18 13:40:59-----------------------------------\r\n",
      "... ... 2021-6-18 13:40:59 Solved BSE for singlets \r\n",
      "... ...   ====== singlet energies (eV) ====== \r\n",
      "... ...   S =    1 Omega = +7.810277179381 eV  lamdba = +158.77 nm <FT> = +18.1946 <K_x> = +1.7240 <K_d> = -12.1084\r\n",
      "... ...            TrDipole length gauge[e*bohr]  dx = -0.0000 dy = -0.3344 dz = -0.3341 |d|^2 = +0.2235 f = +0.0428\r\n",
      "... ...            HOMO-0   -> LUMO+0    : 95.0%\r\n",
      "... ... \r\n",
      "... ...   S =    2 Omega = +7.810184465358 eV  lamdba = +158.77 nm <FT> = +18.1949 <K_x> = +1.7239 <K_d> = -12.1086\r\n",
      "... ...            TrDipole length gauge[e*bohr]  dx = +0.0000 dy = -0.3341 dz = +0.3344 |d|^2 = +0.2234 f = +0.0428\r\n",
      "... ...            HOMO-0   -> LUMO+1    : 95.0%\r\n",
      "... ... \r\n",
      "... ...   S =    3 Omega = +8.627511127243 eV  lamdba = +143.73 nm <FT> = +19.9580 <K_x> = +0.0000 <K_d> = -11.3306\r\n",
      "... ...            TrDipole length gauge[e*bohr]  dx = +0.0000 dy = -0.0000 dz = +0.0000 |d|^2 = +0.0000 f = +0.0000\r\n",
      "... ... \r\n",
      "... ...   S =    4 Omega = +9.230257898007 eV  lamdba = +134.34 nm <FT> = +19.8863 <K_x> = +1.4914 <K_d> = -12.1475\r\n",
      "... ...            TrDipole length gauge[e*bohr]  dx = +0.0000 dy = +0.0000 dz = -0.0000 |d|^2 = +0.0000 f = +0.0000\r\n",
      "... ... \r\n",
      "... ...   S =    5 Omega = +9.230248873883 eV  lamdba = +134.34 nm <FT> = +19.8863 <K_x> = +1.4914 <K_d> = -12.1474\r\n",
      "... ...            TrDipole length gauge[e*bohr]  dx = +0.0000 dy = -0.0000 dz = -0.0000 |d|^2 = +0.0000 f = +0.0000\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:40:59 GWBSE calculation finished \r\n",
      "... ... Next State is: s1\r\n",
      "... ... 2021-6-18 13:40:59 Using 2 threads\r\n",
      "... ... 2021-6-18 13:40:59 Using native Eigen implementation, no BLAS overload \r\n",
      "... ...  Molecule Coordinates [A] \r\n",
      "... ...   C   -0.0010 +0.0000 +0.0000\r\n",
      "... ...   O   +1.2000 +0.0000 +0.0000\r\n",
      "... ... 2021-6-18 13:40:59 Loaded DFT Basis Set 3-21G with 18 functions\r\n",
      "... ... 2021-6-18 13:40:59 Loaded AUX Basis Set aux-def2-svp with 96 functions\r\n",
      "... ... 2021-6-18 13:40:59 Total number of electrons: 14\r\n",
      "... ... 2021-6-18 13:40:59 Smallest value of AOOverlap matrix is 0.0514048041452\r\n",
      "... ... 2021-6-18 13:40:59 Removed 0 basisfunction from inverse overlap matrix\r\n",
      "... ... 2021-6-18 13:40:59 Convergence Options:\r\n",
      "... ... \t\t Delta E [Ha]: 1e-07\r\n",
      "... ... \t\t DIIS max error: 1e-07\r\n",
      "... ... \t\t DIIS histlength: 20\r\n",
      "... ... \t\t ADIIS start: 0.8\r\n",
      "... ... \t\t DIIS start: 0.002\r\n",
      "... ... \t\t Deleting oldest element from DIIS hist\r\n",
      "... ... \t\t Levelshift[Ha]: 0\r\n",
      "... ... \t\t Levelshift end: 0.2\r\n",
      "... ... \t\t Mixing Parameter alpha: 0.7\r\n",
      "... ... 2021-6-18 13:40:59 Setup invariant parts of Electron Repulsion integrals \r\n",
      "... ... 2021-6-18 13:40:59 Constructed independent particle hamiltonian \r\n",
      "... ... 2021-6-18 13:40:59 Nuclear Repulsion Energy is 21.1494654\r\n",
      "... ... 2021-6-18 13:40:59 Using hybrid functional with alpha=0.25\r\n",
      "... ... 2021-6-18 13:40:59 Setup numerical integration grid medium for vxc functional XC_HYB_GGA_XC_PBEH\r\n",
      "... ... 2021-6-18 13:40:59 Setup Initial Guess using: atom\r\n",
      "... ... 2021-6-18 13:40:59 Calculating atom density for C\r\n",
      "... ... 2021-6-18 13:40:59 Calculating atom density for O\r\n",
      "... ... 2021-6-18 13:41:0 STARTING SCF cycle\r\n",
      "... ...  --------------------------------------------------------------------------\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:0 Iteration 1 of 100\r\n",
      "... ... 2021-6-18 13:41:0 Total Energy -112.363348396\r\n",
      "... ... 2021-6-18 13:41:0 DIIs error 0.359689287921\r\n",
      "... ... 2021-6-18 13:41:0 Delta Etot 0\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:0 Iteration 2 of 100\r\n",
      "... ... 2021-6-18 13:41:0 Total Energy -112.397941721\r\n",
      "... ... 2021-6-18 13:41:0 DIIs error 0.138198755706\r\n",
      "... ... 2021-6-18 13:41:0 Delta Etot -0.0345933248607\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:0 Iteration 3 of 100\r\n",
      "... ... 2021-6-18 13:41:0 Total Energy -112.442727564\r\n",
      "... ... 2021-6-18 13:41:0 DIIs error 0.100161620444\r\n",
      "... ... 2021-6-18 13:41:0 Delta Etot -0.044785843282\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:0 Iteration 4 of 100\r\n",
      "... ... 2021-6-18 13:41:0 Total Energy -112.523762357\r\n",
      "... ... 2021-6-18 13:41:0 DIIs error 0.120929077753\r\n",
      "... ... 2021-6-18 13:41:0 Delta Etot -0.0810347930655\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:0 Iteration 5 of 100\r\n",
      "... ... 2021-6-18 13:41:0 Total Energy -112.509203212\r\n",
      "... ... 2021-6-18 13:41:0 DIIs error 0.163624870647\r\n",
      "... ... 2021-6-18 13:41:0 Delta Etot 0.0145591452087\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:0 Iteration 6 of 100\r\n",
      "... ... 2021-6-18 13:41:0 Total Energy -112.544385959\r\n",
      "... ... 2021-6-18 13:41:0 DIIs error 0.0169695879996\r\n",
      "... ... 2021-6-18 13:41:0 Delta Etot -0.0351827475891\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:0 Iteration 7 of 100\r\n",
      "... ... 2021-6-18 13:41:0 Total Energy -112.542191136\r\n",
      "... ... 2021-6-18 13:41:0 DIIs error 0.0441033266944\r\n",
      "... ... 2021-6-18 13:41:0 Delta Etot 0.00219482317235\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:0 Iteration 8 of 100\r\n",
      "... ... 2021-6-18 13:41:0 Total Energy -112.54460756\r\n",
      "... ... 2021-6-18 13:41:0 DIIs error 0.0124263066123\r\n",
      "... ... 2021-6-18 13:41:0 Delta Etot -0.00241642363908\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:0 Iteration 9 of 100\r\n",
      "... ... 2021-6-18 13:41:1 Total Energy -112.544802837\r\n",
      "... ... 2021-6-18 13:41:1 DIIs error 0.00364634146456\r\n",
      "... ... 2021-6-18 13:41:1 Delta Etot -0.000195276703295\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:1 Iteration 10 of 100\r\n",
      "... ... 2021-6-18 13:41:1 Total Energy -112.54479146\r\n",
      "... ... 2021-6-18 13:41:1 DIIs error 0.00467655635097\r\n",
      "... ... 2021-6-18 13:41:1 Delta Etot 1.13765577652e-05\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:1 Iteration 11 of 100\r\n",
      "... ... 2021-6-18 13:41:1 Total Energy -112.54482026\r\n",
      "... ... 2021-6-18 13:41:1 DIIs error 0.000493992840481\r\n",
      "... ... 2021-6-18 13:41:1 Delta Etot -2.87995748351e-05\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:1 Iteration 12 of 100\r\n",
      "... ... 2021-6-18 13:41:1 Total Energy -112.544820586\r\n",
      "... ... 2021-6-18 13:41:1 DIIs error 2.81009038609e-06\r\n",
      "... ... 2021-6-18 13:41:1 Delta Etot -3.26195703337e-07\r\n",
      "... ... \r\n",
      "... ... 2021-6-18 13:41:1 Iteration 13 of 100\r\n",
      "... ... 2021-6-18 13:41:1 Total Energy -112.544820586\r\n",
      "... ... 2021-6-18 13:41:1 DIIs error 3.15397700156e-08\r\n",
      "... ... 2021-6-18 13:41:1 Delta Etot -1.24060761664e-11\r\n",
      "... ... 2021-6-18 13:41:1 Total Energy has converged to -1.24060762e-11[Ha] after 13 iterations. DIIS error is converged up to 3.153977e-08\r\n",
      "... ... 2021-6-18 13:41:1 Final Single Point Energy -112.544820586 Ha\r\n",
      "... ... 2021-6-18 13:41:1 Final Local Exc contribution -10.3496627823 Ha\r\n",
      "... ... 2021-6-18 13:41:1 Final Non Local Ex contribution -3.29348712222 Ha\r\n",
      "... ...   Orbital energies: \r\n",
      "... ...   index occupation energy(Hartree) \r\n",
      "... ...      0      2   -19.2419926213\r\n",
      "... ...      1      2   -10.3171703227\r\n",
      "... ...      2      2   -1.1830184049\r\n",
      "... ...      3      2   -0.5764080921\r\n",
      "... ...      4      2   -0.4655877128\r\n",
      "... ...      5      2   -0.4655877123\r\n",
      "... ...      6      2   -0.3809220001\r\n",
      "... ...      7      0   -0.0347928718\r\n",
      "... ...      8      0   -0.0347928716\r\n",
      "... ...      9      0   +0.3130644352\r\n",
      "... ...     10      0   +0.7020411087\r\n",
      "... ...     11      0   +0.7020411088\r\n",
      "... ...     12      0   +0.7858424713\r\n",
      "... ...     13      0   +1.0523479967\r\n",
      "... ...     14      0   +1.4533267351\r\n",
      "... ...     15      0   +1.4533267353\r\n",
      "... ...     16      0   +1.5025454589\r\n",
      "... ...     17      0   +2.9062516318\r\n",
      "... ... 2021-6-18 13:41:1 Electric Dipole is[e*bohr]:\r\n",
      "\t\t dx=-0.0508623561865\r\n",
      "\t\t dy=2.28277174131e-09\r\n",
      "\t\t dz=2.28277968694e-09\r\n",
      "... ... Writing result to CO.orb\r\n",
      "... ... Parsing DFT data from CO.orb and CO.orb\r\n",
      "... ... QM energy[Hrt]: -112.54482059 \r\n",
      "... ... 2021-6-18 13:41:1 RPA level range [0:17]\r\n",
      "... ... 2021-6-18 13:41:1 GW  level range [0:17]\r\n",
      "... ... 2021-6-18 13:41:1 BSE level range occ[0:6]  virt[7:17]\r\n",
      "... ...  BSE type: full\r\n",
      "... ... 2021-6-18 13:41:1 BSE Hamiltonian has size 154x154\r\n",
      "... ...  BSE without Hqp offdiagonal elements\r\n",
      "... ...  Running GW as: evGW\r\n",
      "... ...  g_sc_limit [Hartree]: 1e-05\r\n",
      "... ...  gw_sc_limit [Hartree]: 1e-05\r\n",
      "... ...  Tasks: \r\n",
      "... ...  GW \r\n",
      "... ...  singlets \r\n",
      "... ...  Store: \r\n",
      "... ...  GW \r\n",
      "... ...  Sigma integration: ppm\r\n",
      "... ...  eta: 0.001\r\n",
      "... ...  Quadrature integration order : 12\r\n",
      "... ...  Quadrature integration scheme : legendre\r\n",
      "... ...  Alpha smoothing parameter : 0.001\r\n",
      "... ...  QP solver: grid\r\n",
      "... ...  QP grid steps: 1001\r\n",
      "... ...  QP grid spacing: 0.001\r\n",
      "... ...  evGW with Anderson update with history 20 using alpha 0.7\r\n",
      "... ... 2021-6-18 13:41:1 Using 2 threads\r\n",
      "... ... 2021-6-18 13:41:1 Using native Eigen implementation, no BLAS overload \r\n",
      "... ... 2021-6-18 13:41:1 Molecule Coordinates [A] \r\n",
      "... ...     0    C   -0.0010 0.0000 0.0000\r\n",
      "... ...     1    O   1.2000 0.0000 0.0000\r\n",
      "... ... 2021-6-18 13:41:1 DFT data was created by xtp\r\n",
      "... ... 2021-6-18 13:41:1 Loaded DFT Basis Set 3-21G\r\n",
      "... ... 2021-6-18 13:41:1 Filled DFT Basis of size 18\r\n",
      "... ... 2021-6-18 13:41:1 Loaded Auxbasis Set aux-def2-svp\r\n",
      "... ... 2021-6-18 13:41:1 Filled Auxbasis of size 96\r\n",
      "... ... 2021-6-18 13:41:1 Calculating Mmn_beta (3-center-repulsion x orbitals)  \r\n",
      "... ... 2021-6-18 13:41:1 Calculated Mmn_beta (3-center-repulsion x orbitals)  \r\n",
      "... ... 2021-6-18 13:41:1 Integrating Vxc with functional XC_HYB_GGA_XC_PBEH\r\n",
      "... ... 2021-6-18 13:41:1 Set hybrid exchange factor: 0.25\r\n",
      "... ... 2021-6-18 13:41:1 Calculated exchange-correlation expectation values \r\n",
      "... ... 2021-6-18 13:41:1 Calculated Hartree exchange contribution\r\n",
      "... ... 2021-6-18 13:41:1 Scissor shifting DFT energies by: 0 Hrt\r\n",
      "... ...   ====== Perturbative quasiparticle energies (Hartree) ====== \r\n",
      "... ...    DeltaHLGap = +0.289998 Hartree\r\n",
      "... ...   Level =    0 DFT = -19.2420 VXC = -2.3112 S-X = -3.6464 S-C = +0.5608 GWA = -20.0165\r\n",
      "... ...   Level =    1 DFT = -10.3172 VXC = -1.7029 S-X = -2.6729 S-C = +0.2826 GWA = -11.0046\r\n",
      "... ...   Level =    2 DFT = -1.1830 VXC = -0.6133 S-X = -0.9167 S-C = +0.1553 GWA = -1.3310\r\n",
      "... ...   Level =    3 DFT = -0.5764 VXC = -0.5626 S-X = -0.7696 S-C = +0.0853 GWA = -0.6980\r\n",
      "... ...   Level =    4 DFT = -0.4656 VXC = -0.5081 S-X = -0.6424 S-C = +0.0198 GWA = -0.5801\r\n",
      "... ...   Level =    5 DFT = -0.4656 VXC = -0.5081 S-X = -0.6424 S-C = +0.0198 GWA = -0.5801\r\n",
      "... ...   HOMO  =    6 DFT = -0.3809 VXC = -0.4455 S-X = -0.5900 S-C = +0.0344 GWA = -0.4910\r\n",
      "... ...   LUMO  =    7 DFT = -0.0348 VXC = -0.4302 S-X = -0.2454 S-C = -0.0049 GWA = +0.1451\r\n",
      "... ...   Level =    8 DFT = -0.0348 VXC = -0.4302 S-X = -0.2454 S-C = -0.0049 GWA = +0.1451\r\n",
      "... ...   Level =    9 DFT = +0.3131 VXC = -0.3263 S-X = -0.1507 S-C = -0.0130 GWA = +0.4758\r\n",
      "... ...   Level =   10 DFT = +0.7020 VXC = -0.3343 S-X = -0.0931 S-C = -0.0698 GWA = +0.8735\r\n",
      "... ...   Level =   11 DFT = +0.7020 VXC = -0.3343 S-X = -0.0931 S-C = -0.0698 GWA = +0.8735\r\n",
      "... ...   Level =   12 DFT = +0.7858 VXC = -0.4740 S-X = -0.2015 S-C = -0.0614 GWA = +0.9969\r\n",
      "... ...   Level =   13 DFT = +1.0523 VXC = -0.4110 S-X = -0.1756 S-C = -0.0811 GWA = +1.2067\r\n",
      "... ...   Level =   14 DFT = +1.4533 VXC = -0.5240 S-X = -0.1917 S-C = -0.2321 GWA = +1.5535\r\n",
      "... ...   Level =   15 DFT = +1.4533 VXC = -0.5240 S-X = -0.1917 S-C = -0.2321 GWA = +1.5535\r\n",
      "... ...   Level =   16 DFT = +1.5025 VXC = -0.5044 S-X = -0.1976 S-C = -0.1226 GWA = +1.6867\r\n",
      "... ...   Level =   17 DFT = +2.9063 VXC = -0.5573 S-X = -0.2106 S-C = +0.0443 GWA = +3.2973\r\n",
      "... ... 2021-6-18 13:41:1 Calculated offdiagonal part of Sigma  \r\n",
      "... ... 2021-6-18 13:41:1 Full quasiparticle Hamiltonian  \r\n",
      "... ...   ====== Diagonalized quasiparticle energies (Hartree) ====== \r\n",
      "... ...   Level =    0 PQP = -20.016506 DQP = -20.016768 \r\n",
      "... ...   Level =    1 PQP = -11.004568 DQP = -11.004832 \r\n",
      "... ...   Level =    2 PQP = -1.331026 DQP = -1.331829 \r\n",
      "... ...   Level =    3 PQP = -0.697993 DQP = -0.698470 \r\n",
      "... ...   Level =    4 PQP = -0.580133 DQP = -0.585022 \r\n",
      "... ...   Level =    5 PQP = -0.580133 DQP = -0.585022 \r\n",
      "... ...   HOMO  =    6 PQP = -0.491028 DQP = -0.491359 \r\n",
      "... ...   LUMO  =    7 PQP = +0.145099 DQP = +0.143300 \r\n",
      "... ...   Level =    8 PQP = +0.145099 DQP = +0.143300 \r\n",
      "... ...   Level =    9 PQP = +0.475757 DQP = +0.473245 \r\n",
      "... ...   Level =   10 PQP = +0.873461 DQP = +0.873384 \r\n",
      "... ...   Level =   11 PQP = +0.873461 DQP = +0.873384 \r\n",
      "... ...   Level =   12 PQP = +0.996939 DQP = +0.994504 \r\n",
      "... ...   Level =   13 PQP = +1.206719 DQP = +1.208374 \r\n",
      "... ...   Level =   14 PQP = +1.553534 DQP = +1.560299 \r\n",
      "... ...   Level =   15 PQP = +1.553534 DQP = +1.560299 \r\n",
      "... ...   Level =   16 PQP = +1.686704 DQP = +1.679212 \r\n",
      "... ...   Level =   17 PQP = +3.297271 DQP = +3.310193 \r\n",
      "... ... 2021-6-18 13:41:1 Diagonalized QP Hamiltonian  \r\n",
      "... ... 2021-6-18 13:41:1 Setup Full singlet hamiltonian \r\n",
      "... ... 2021-6-18 13:41:1 Davidson Solver using 2 threads.\r\n",
      "... ... 2021-6-18 13:41:1 Tolerance : 0.0001\r\n",
      "... ... 2021-6-18 13:41:1 DPR Correction\r\n",
      "... ... 2021-6-18 13:41:1 Matrix size : 154x154\r\n",
      "... ... 2021-6-18 13:41:1 iter\tSearch Space\tNorm\r\n",
      "... ... 2021-6-18 13:41:1    0           10 \t  nan \t  0.00% convergedan error occurred:\r\n",
      "Small generalized eigenvalue problem failed.\r\n"
     ]
    }
   ],
   "source": [
    "!xtp_tools -n CO -e dftgwbse -o OPTIONFILES/dftgwbse.xml -t 2"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Notice that we are using 4 threads. The results will be stored in a file named `CO_summary.xml` in the current work directory, together with the optimization step in `optimisation.trj` and the orbitals in [hdf5 format](https://www.hdfgroup.org/solutions/hdf5/) saved on `CO.orb`."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
